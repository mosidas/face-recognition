# 顔認識システム仕様書

## システム概要

C# .NET 8を使用したリアルタイム顔認識システムで、物体検出、顔認識、スマートフォン認証機能を統合したONNXモデルベースのシステムです。

## 主要コンポーネント

### 1. Recognizerライブラリ (`src/Recognizer/`)

コンピュータビジョンとAI機能を提供する中核ライブラリ：

- **FaceRecognizer**: 顔認識・照合機能を持つメインクラス
- **YoloFaceDetector**: YOLOv8n-face/YOLOv11-faceモデルを使用した顔検出
- **YoloDetector**: 一般的な物体検出用YOLOモデル
- **OnnxHelper**: GPU加速対応のONNXモデル推論ユーティリティ
- **FaceAngleCalculator**: 顔の向き角度計算（roll, pitch, yaw）
- **Constants**: 閾値と画像処理用の設定定数

### 2. アプリケーションプロジェクト

#### ExampleCLI (`src/ExampleCLI/`)
- 検出・認識機能をテストするコマンドラインインターフェース
- 基本的な顔検出・認識テスト機能

#### RealTimeDetector (`src/RealTimeDetector/`)
- デュアルモードでのリアルタイムカメラ処理：
  - 物体検出モード
  - 顔検出モード
- ビジュアルオーバーレイ付きライブ映像処理

#### RealTimeFaceRecognizer (`src/RealTimeFaceRecognizer/`)
- データベース照合によるリアルタイム顔認識
- 参照顔画像の読み込みと比較
- 詳細な類似度分析とログ出力

#### UnifiedDetector (`src/UnifiedDetector/`)
- **高度な統合システム**として以下を組み合わせ：
  - 物体検出
  - 顔認識
  - **スマートフォン認証**（独自機能）

## 主要機能

### 1. マルチモデル対応
- **YOLOv8n-face**: 標準[1, 25200, 5]および転置[1, 20, 8400]出力
- **YOLOv11-face**: 転置[1, 5, 8400]出力
- 自動モデルタイプ検出とフォーマット処理

### 2. リアルタイム処理
- CUDA利用可能時のGPU加速
- ライブカメラフィード用最適化
- 適切な廃棄パターンによる効率的メモリ管理

### 3. 顔分析機能
- **顔検出**: 信頼度スコア付きバウンディングボックス検出
- **顔認識**: 参照データベースとの類似度照合
- **ランドマーク検出**: 5点顔部品検出（目、鼻、口角）
- **角度計算**: 顔の向き（roll, pitch, yaw角度）

### 4. スマートフォン認証（UnifiedDetector）
- **人物ベース認証**: 「person」物体検出をプライマリコンテナとして使用
- **多段階プロセス**：
  1. フレーム内の「person」オブジェクトを検出
  2. person境界ボックス内の顔を特定
  3. 参照データベースに対する顔認証（閾値：0.4類似度）
  4. 同じperson境界ボックス内のスマートフォンを検出
  5. 認証された顔と関連するスマートフォンを「認証済み」としてマーク

- **視覚的表示**：
  - 認証済みスマートフォン: 紫色境界ボックス、「[認証済み]」ラベル
  - 未認証スマートフォン: オレンジ色境界ボックス、「[未認証]」ラベル
  - 一般オブジェクト: 緑色境界ボックス

### 5. ビジュアル表示
- **顔認識表示**：
  - 信頼度レベル別色分け：
    - 青：高信頼度（≥0.6類似度）
    - 黄：中信頼度（0.4-0.6類似度）
    - 赤：低信頼度（<0.4類似度）
  - リアルタイム角度表示：Roll, Pitch, Yaw値
  - 名前と類似度スコアのオーバーレイ

- **フォント表示**: 読みやすさ向上のためHersheyDuplexフォント使用
- **背景テキスト**: テキスト視認性向上のための黒背景

## 設定パラメータ

### 検出閾値
- **顔検出**: 0.7信頼度閾値
- **顔認識**: 0.4類似度閾値（設定可能）
- **物体検出**: 0.5信頼度閾値
- **NMS（Non-Maximum Suppression）**: 0.5 IoU閾値

### 処理最適化
- **画像ダウンスケール**: 高速処理のための設定可能比率
- **非同期操作**: 全推論操作でasync/awaitパターン使用
- **リソース管理**: ONNXセッションとOpenCVオブジェクトの自動廃棄

## システム要件

### ハードウェア要件
- **CPU**: x64アーキテクチャ（推奨：4コア以上）
- **メモリ**: 8GB RAM以上（推奨：16GB）
- **GPU**: CUDA対応GPU（オプション、パフォーマンス向上のため）
- **ストレージ**: 2GB以上の空き容量
- **カメラ**: USB/内蔵Webカメラ

### ソフトウェア要件
- **.NET 8 Runtime**: 必須
- **Visual Studio 2022**: 開発時（推奨）
- **CUDA Toolkit**: GPU使用時（オプション）
- **Windows 10/11**: 動作確認済み

### モデル要件
- **顔検出モデル**: YOLOv8n-face/YOLOv11-face ONNX形式
- **顔認識モデル**: 埋め込みベクトル生成ONNX形式
- **物体検出モデル**: YOLO系ONNX形式（COCO dataset対応）

## コマンドラインインターフェース

### UnifiedDetector使用方法
```bash
dotnet run --project src/UnifiedDetector/UnifiedDetector.csproj -- \
  --face-detector path/to/face_model.onnx \
  --face-recognizer path/to/recognition_model.onnx \
  --object-model path/to/object_model.onnx \
  --face-images path/to/reference_faces/ \
  --confidence 0.5 \
  --recognition-threshold 0.4 \
  --camera 0 \
  --enable-objects true \
  --enable-faces true
```

### パラメータ
- `--face-detector`: 顔検出ONNXモデルパス（必須）
- `--face-recognizer`: 顔認識ONNXモデルパス（必須）
- `--object-model`: 物体検出ONNXモデルパス（オプション）
- `--face-images`: 参照顔画像フォルダパス（オプション）
- `--confidence`: 物体検出信頼度閾値（デフォルト: 0.5）
- `--recognition-threshold`: 顔認識類似度閾値（デフォルト: 0.6）
- `--camera`: カメラインデックス（デフォルト: 0）
- `--enable-objects`: 物体検出有効化（デフォルト: true）
- `--enable-faces`: 顔認識有効化（デフォルト: true）

## 技術アーキテクチャ

### 依存関係
- **Microsoft.ML.OnnxRuntime**: ONNXモデル推論
- **OpenCvSharp4**: コンピュータビジョン操作
- **System.CommandLine**: CLIパラメータ解析
- **System.Numerics.Tensors**: テンソル演算
- **SixLabors.ImageSharp**: 画像処理

### パフォーマンス最適化
1. **GPU加速**: 自動CUDA検出と利用
2. **非同期処理**: 検出・認識タスクの並列実行
3. **メモリ管理**: 効率的なテンソル操作とリソース廃棄
4. **画像スケーリング**: パフォーマンス調整のための設定可能ダウンスケール

### エラー処理
- GPU→CPU推論への優雅なフォールバック
- モデル読み込み・推論の包括的例外処理
- デバッグ・監視のための詳細ログ出力

## セキュリティ機能

### スマートフォン認証ロジック
1. **人物検出**: 「person」物体検出を使用したプライマリセキュリティ境界
2. **顔認証**: 顔認識による多要素認証
3. **空間相関**: 人物境界内で認証された顔と空間的に関連するスマートフォンのみ認証
4. **閾値ベースセキュリティ**: 認証レベル用の設定可能類似度閾値

### ビジュアルセキュリティ表示
- 認証済み・未認証デバイスの明確な区別
- リアルタイム信頼度レベルと類似度スコア
- セキュリティコンテキストのための人物境界可視化

## トラブルシューティング

### よくある問題
1. **カメラアクセスエラー**
   - 症状：カメラを開けない
   - 解決方法：カメラインデックスを変更（--camera 1, 2...）、他のアプリケーションでカメラが使用されていないか確認

2. **GPU推論エラー**
   - 症状：CUDA初期化失敗
   - 解決方法：自動的にCPU推論にフォールバック、CUDA Toolkitインストール確認

3. **モデル読み込みエラー**
   - 症状：ONNXモデルが読み込めない
   - 解決方法：ファイルパス確認、モデル形式確認（YOLOv8n-face/YOLOv11-face対応）

### ログ出力
- **コンソール出力**: リアルタイム処理状況
- **パフォーマンス指標**: FPS、処理時間
- **エラー詳細**: スタックトレース付きエラー情報

## セキュリティ考慮事項

### プライバシー保護
- 顔画像データの一時的処理のみ（永続化なし）
- 埋め込みベクトルによる匿名化処理
- ローカル処理によるデータ外部送信なし

### アクセス制御
- カメラアクセス権限の適切な管理
- 参照顔画像フォルダのアクセス制限
- 認証閾値による誤認識防止

## パフォーマンス指標

### 期待値
- **処理速度**: 15-30 FPS（GPU使用時）
- **顔検出精度**: 95%以上（適切な照明条件下）
- **顔認識精度**: 90%以上（参照画像品質に依存）
- **レスポンス時間**: 100ms以下（単一顔処理時）

### 最適化のベストプラクティス
- 画像解像度の調整による処理速度向上
- GPU利用による並列処理
- 参照顔画像の品質向上による認識精度向上

## 将来の拡張

### 計画機能
- 永続的顔認識のためのデータベース統合
- リモートアクセス用Web APIインターフェース
- モバイルアプリケーション統合
- 高度な分析・レポート機能
- マルチカメラ対応
- 強化されたセキュリティプロトコル

### スケーラビリティ考慮事項
- マイクロサービスアーキテクチャ対応
- クラウドデプロイメント互換性
- 分散処理機能
- リアルタイムストリーミング最適化
